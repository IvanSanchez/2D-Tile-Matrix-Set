[appendix]
[[annex-extending-additional-dimensinos]]
:appendix-caption: Annex
== Extending TileMatrixSets for additional dimensions (Informative)

This informative annex proposes approaches to extending TileMatrixSets and TileSet metadata for storing, indexing and accessing as tiles 3D
(e.g. with the third dimension being vertical or temporal), 4D (e.g. spatio-temporal) and n-D (n > 2) data.

=== Extension approaches

All of these approaches assume that the multi-dimensional content still spans the two dimensions defined by 2D TileMatrixSets, which are
usually latitude and longitude for geographic CRSes, and X/Easting or Y/Northing for projected CRSes.

==== No explicit tiling of extra dimensions

One way to extend the use of TileMatrixSet to support additional dimensions is to simply regroup all content falling within a 2D tile boundary of the
TileMatrixSet together in the same tile, for the full extent of those additional dimensions.

[#img_nd_extend,reftext='{figure-caption} {counter:figure-num}']
.Extending TileMatrixSet vertically with no division
image::figures/nd-extend.png[]

Storing, indexing and accessing the content for the additional dimensions can then be achieved through separate mechanisms, such as using formats
supporting multiple dimensions (e.g. netCDF for coverages, glTF for 3D models, LAS for point clouds), and via subsetting mechanisms for access via APIs such as
the `subset` (trimming or slicing) and `datetime` (temporal slicing) query parameters.
Note that the density of the extra dimensions can still be reduced for the lower resolution tile matrices.

This is the approach used in OGC CDB 1.x (see definition of the <<cdb-global-grid-tilematrixset-definition, CDB Global Grid>>).

==== Same division for all tile matrices

Another approach is to also divide the extra dimension(s), but divide them them the same for all tile matrices.

[#img_nd_divide,reftext='{figure-caption} {counter:figure-num}']
.Extending TileMatrixSet vertically with the same division for all tile matrices
image::figures/nd-divide.png[]

Fixed divisions for the extra dimensions may be suitable to scenarios where the extra dimensions have a limited extent, such as
dividing all tile matrices by a small number of floors, by a few segments of altitudes, by month of the year or by a few years.

==== Octrees and Orthtrees (Hyperoctrees)

Finally, it might be beneficial to increase the number of divisions for those additional dimensions for higher resolution tile matrices.
Often, a 2D TileMatrixSet is built as a quad-tree, and a similar approach can be used with additional dimensions where it becomes an octree,
or _orthree_ for higher dimension (orthant being the generalization of quadrants and octants), sometimes also called a _hyperoctree_.

[#img_nd_octree,reftext='{figure-caption} {counter:figure-num}']
.Extending TileMatrixSet vertically as an octree
image::figures/nd-octree.png[]

=== Extended properties for TileMatrixSet schema

The following example introduces a new `extraDimensions` property which can be added to either a TileMatrixSet's TileMatrix or to a
TileSet's TileMatrixSetLimit object to describe how the TileMatrixSet is extended into additional dimensions using
any of the three approaches proposed above.

==== Example TileMatrix

```json
      {
         "identifier" : "0",
         "scaleDenominator" : 139770566.0071794390678,
         "matrixWidth" : 4,
         "matrixHeight" : 2,
         "tileWidth" : 256,
         "tileHeight" : 256,
         "pointOfOrigin" : [ 90, -180 ],
         "extraDimensions" :
         {
            "elevation" : {
               "min" : -12000, "max" : 12000,
               "uom" : "http://www.opengis.net/def/uom/SI/metre",
               "divisions" : 2,
               "resolution" : 1000
            },
            "time" : {
               "min" : "2021-01-01", "max" : "2021-12-31",
               "uom" :  "http://www.opengis.net/def/uom/ISO-8601/0/Gregorian",
               "divisions" : 1,
               "temporalDivision" : "year",
               "temporalResolution" : "month"
            }
         }
      },
```

==== JSON Schema for above example

=== Data contained in tiles

==== Vector features

Many vector formats support geometry with a depth coordinates.

==== Coverages

Coverage tiles can contain an additional dimension, which may or may not have gone through a trim operation.

==== Point Clouds

Point cloud data can be stored in tiles based on TileMatrixSets extended to 3D space, and thinned for lower resolution tile matrices.

==== Points referencing and posing 3D models

Vector tiles referencing individual 3D models (available at `/models/{modelId}` and textures at `/textures/{textureId})`

    trees/tiles/GNOSISGlobalGrid/13/5200/5715.json
    trees/tiles/GNOSISGlobalGrid/13/5200/5715.mvt

Example 3D model & textures:

    trees/models/coniferous_tree01.glb
    trees/models/coniferous_tree01.e3d
    trees/textures/1.jpg

==== Batched 3D Models

glTF, E3D and Batched 3D Model 3D Tile (glTF + a header) tile of all buildings in that tile:

    buildings/tiles/GNOSISGlobalGrid/13/5200/5715.glb
    buildings/tiles/GNOSISGlobalGrid/13/5200/5715.e3d
    buildings/tiles/GNOSISGlobalGrid/13/5200/5715.b3dm

=== Relationship with 3D Tiles and i3s

The _3D Tiles_ and _i3s_ OGC community standards allow to describe Bounding Volume Hierarchies (BVH) of 3D data.
Those BVH _tilesets_ allow dimensions of each tile to differ.
While a TileMatrixSet can be used as the basis for producing _3D Tiles_ or _i3s_ BVH tilesets,
not all _3D Tiles_ or _i3s_ tilesets need to be based on a TileMatrixSet.

When deciding on the use of a TileMatrixSet to define such tilesets, the space is partitioned exactly the same way,
regardless of the content within that space.
This has the advantage of allowing to deterministically access data for a particular portion of space from a fixed location irrespective of
what or how much data may be contained in that space.

An alternative approach allowed by BVH is to distribute the data in tiles based on density, with the objective to balance the amount of data per tile,
reducing the overhead of having many tiles where data is sparse, while avoiding a heavy load per tile in dense areas.

3D datasets based on a TileMatrixSet can be distributed as Tiles just like 2D tilesets instead (or in addition to) as
Bounding Volume Hierarchies (3D Tiles / i3s), where the latter can simply reference the former (e.g. linking to .b3dm files organized in a TileMatrixSet paths).
